# ========================================
# ОПТИМИЗИРОВАННАЯ КОНФИГУРАЦИЯ ДЛЯ SSD
# ========================================

# Сетевые настройки для Docker
listen_addresses = '0.0.0.0'
port = 5432

# ========================================
# ПОДКЛЮЧЕНИЯ
# ========================================
max_connections = 100
superuser_reserved_connections = 5

# Безопасность (SSL отключен для внутренней сети Docker)
ssl = off

# ========================================
# ПАМЯТЬ (оптимизировано)
# ========================================
# shared_buffers = 25% от RAM (если у вас 2GB RAM на контейнер)
shared_buffers = 512MB                    # ✅ Было 128MB → увеличили в 4 раза
effective_cache_size = 2GB                # ✅ Было 256MB → увеличили в 8 раз
work_mem = 32MB                           # ✅ Было 4MB → увеличили в 8 раз
maintenance_work_mem = 128MB              # ✅ Было 64MB → увеличили в 2 раза

# ========================================
# CHECKPOINT (КРИТИЧНО ДЛЯ SSD!)
# ========================================
checkpoint_timeout = 15min                # ✅ Было 30min → уменьшили (чаще но быстрее)
checkpoint_completion_target = 0.9
max_wal_size = 2GB                        # ✅ Оставили 2GB (хорошо)
min_wal_size = 512MB                      # ✅ Добавили (было не указано)
wal_buffers = 32MB                        # ✅ Добавили
wal_compression = on                      # ✅ Добавили (для SSD можно)
wal_writer_delay = 10ms                   # ✅ Добавили (меньше задержка для SSD)

# ========================================
# SSD ОПТИМИЗАЦИИ (КРИТИЧНО!)
# ========================================
random_page_cost = 1.1                    # ✅ Для SSD (по умолчанию 4.0 для HDD)
effective_io_concurrency = 200            # ✅ Для SSD (по умолчанию 1 для HDD)
seq_page_cost = 1.0                       # ✅ Для SSD

# ========================================
# BGWRITER (оптимизировано для SSD)
# ========================================
bgwriter_delay = 50ms                     # ✅ Оставили (хорошо)
bgwriter_lru_maxpages = 500               # ✅ Оставили (хорошо)
bgwriter_lru_multiplier = 2.0             # ✅ Добавили

# ========================================
# СИНХРОНИЗАЦИЯ (ВАЖНО!)
# ========================================
synchronous_commit = off

# ========================================
# AUTOVACUUM (оптимизировано для SSD)
# ========================================
autovacuum = on
autovacuum_max_workers = 4                # ✅ Добавили (больше воркеров)
autovacuum_naptime = 30s                  # ✅ Добавили (чаще запускать)
autovacuum_vacuum_cost_delay = 2ms        # ✅ Добавили (меньше задержка для SSD)
autovacuum_vacuum_cost_limit = 400        # ✅ Добавили (больше операций)

# ========================================
# ЗАЩИТА ОТ DoS И ЗАВИСАНИЙ
# ========================================
statement_timeout = 30000                 # ✅ Было 300000 (5 мин) → 30 сек
idle_in_transaction_session_timeout = 60000  # ✅ Было 600000 (10 мин) → 1 мин
lock_timeout = 10000                      # ✅ Было 30000 (30 сек) → 10 сек
idle_session_timeout = 300000             # ✅ Добавили (5 мин для idle сессий)

# ========================================
# ЛОГИРОВАНИЕ И АУДИТ
# ========================================
log_connections = on
log_disconnections = on
log_duration = off
log_statement = 'none'                    # ddl, mod, all, none
log_min_duration_statement = 1000         # Логировать медленные запросы >1 сек
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on                      # ✅ Добавили (важно для диагностики!)
log_lock_waits = on                       # ✅ Добавили (логировать блокировки)
log_temp_files = 0                        # ✅ Добавили (логировать temp файлы)
log_autovacuum_min_duration = 0           # ✅ Добавили (логировать vacuum)

# ========================================
# МОНИТОРИНГ
# ========================================
shared_preload_libraries = 'pg_stat_statements'
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
track_activity_query_size = 2048          # ✅ Добавили

# Настройки pg_stat_statements
pg_stat_statements.max = 10000            # ✅ Добавили
pg_stat_statements.track = all            # ✅ Добавили

# ========================================
# ДОПОЛНИТЕЛЬНЫЕ ОПТИМИЗАЦИИ
# ========================================
# Планировщик запросов
default_statistics_target = 100
constraint_exclusion = partition
cursor_tuple_fraction = 0.1

# Parallel query (если PostgreSQL 14+)
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_worker_processes = 8

# Временные файлы
temp_file_limit = -1
