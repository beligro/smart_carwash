# Предотвращение дублирования сессий

## Проблема
1С отправляет несколько одинаковых запросов с одним номером машины подряд, что приводит к созданию дублирующихся сессий.

## Решение
Реализован комбинированный подход для предотвращения дублирования сессий:

### 1. Программная проверка
- **В методе `CreateFromCashier`**: проверка существующей активной сессии по номеру машины перед созданием новой
- **В методе `CreateSession`**: аналогичная проверка для обычных пользователей
- При обнаружении дубликата возвращается существующая сессия (для кассира) или ошибка (для пользователей)

### 2. Уникальный индекс в БД
- Создан частичный уникальный индекс `idx_sessions_car_number_unique_active`
- Действует только для активных сессий: `status IN ('created', 'in_queue', 'assigned', 'active')`
- Предотвращает дубликаты на уровне базы данных

### 3. Обработка ошибок БД
- При нарушении уникального индекса система ищет существующую сессию
- Возвращает существующую сессию вместо ошибки
- Логирует все случаи дублирования

## Файлы изменений

### Backend
- `internal/domain/session/service/service.go` - добавлена проверка дубликатов
- `internal/domain/session/handlers/handlers.go` - улучшено логирование
- `migrations/000038_add_unique_car_number_index.up.sql` - уникальный индекс
- `migrations/000038_add_unique_car_number_index.down.sql` - откат индекса

## Логирование
Добавлено детальное логирование для отслеживания:
- Попыток создания дубликатов
- Найденных существующих сессий
- Ошибок уникального индекса
- Результатов обработки запросов от 1С

## Метрики
Записываются метрики попыток создания дубликатов:
- `RecordMultipleSession("duplicate_car_number", carNumber, "0")`

## Тестирование
Для тестирования отправьте несколько одинаковых запросов от 1С с одним номером машины:
- Первый запрос создаст сессию
- Последующие запросы вернут существующую сессию
- В логах будут записи о предотвращении дубликатов

## Запуск миграции
```bash
cd /home/artem/smart_carwash/smart_carwash/backend
go run cmd/main.go migrate up
```
