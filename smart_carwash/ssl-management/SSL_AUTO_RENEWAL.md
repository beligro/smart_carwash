# Автоматическое обновление SSL сертификатов

## Обзор

Система автоматического обновления SSL сертификатов Let's Encrypt для проекта Smart Carwash. Обеспечивает автоматическое обновление сертификатов за 30 дней до истечения срока действия.

## Компоненты системы

### 1. Основные скрипты

#### `ssl_renew_simple.sh` - Основной скрипт обновления
- Проверяет срок действия сертификата
- Обновляет сертификат при необходимости
- Использует Docker для работы с certbot
- Автоматически перезапускает nginx

**Использование:**
```bash
# Из корня проекта (рекомендуется)
./ssl-renew

# Или из папки ssl-management
cd ssl-management
./ssl_renew_simple.sh

# Принудительное обновление
./ssl-renew force

# Только проверка статуса
./ssl-renew check
```

#### `ssl_check.sh` - Скрипт проверки статуса
- Проверяет статус nginx
- Анализирует срок действия сертификата
- Тестирует SSL соединение
- Показывает детали сертификата

**Использование:**
```bash
# Из корня проекта (рекомендуется)
./ssl-check

# Или из папки ssl-management
cd ssl-management
./ssl_check.sh

# Проверка только срока действия
./ssl-check expiry

# Проверка только nginx
./ssl-check nginx

# Тест SSL соединения
./ssl-check ssl
```

### 2. Автоматизация

#### Cron задачи
Настроены следующие автоматические задачи:

```cron
# Проверка SSL сертификата каждый день в 2:00 утра
0 2 * * * /home/artem/smart_carwash/smart_carwash/ssl_renew_simple.sh >> /home/artem/smart_carwash/smart_carwash/logs/ssl_auto_renew.log 2>&1

# Дополнительная проверка каждые 6 часов
0 */6 * * * /home/artem/smart_carwash/smart_carwash/ssl_check.sh >> /home/artem/smart_carwash/smart_carwash/logs/ssl_check.log 2>&1

# Еженедельная проверка статуса (воскресенье в 3:00 утра)
0 3 * * 0 /home/artem/smart_carwash/smart_carwash/ssl_check.sh

# Очистка старых логов (каждый месяц)
0 4 1 * * find /home/artem/smart_carwash/smart_carwash/logs -name "ssl_*.log" -mtime +30 -delete
```

### 3. Логирование

#### Лог файлы
- `/home/artem/smart_carwash/smart_carwash/logs/ssl_auto_renew.log` - логи обновления
- `/home/artem/smart_carwash/smart_carwash/logs/ssl_check.log` - логи проверок

#### Формат логов
```
[2025-09-17 18:33:21] === Запуск проверки SSL сертификата ===
[2025-09-17 18:33:21] Сертификат истекает: Dec 16 17:34:26 2025 GMT (через 89 дней)
[2025-09-17 18:33:21] INFO: Сертификат действителен более 30 дней
[2025-09-17 18:33:21] === Проверка SSL сертификата завершена ===
```

## Конфигурация

### Переменные окружения
```bash
DOMAIN="h2o-nsk.ru"
NGINX_SSL_DIR="/home/artem/smart_carwash/smart_carwash/nginx/ssl"
PROJECT_DIR="/home/artem/smart_carwash/smart_carwash"
LOG_FILE="/home/artem/smart_carwash/smart_carwash/logs/ssl_renew.log"
```

### Docker конфигурация
Обновлен `docker-compose.yml` для поддержки автообновления:
```yaml
nginx:
  volumes:
    - ./nginx/ssl:/etc/nginx/ssl
    - /var/log/ssl_auto_renew.log:/var/log/ssl_auto_renew.log:ro
    - /var/log/ssl_check.log:/var/log/ssl_check.log:ro
```

## Процесс обновления

### 1. Проверка срока действия
- Скрипт проверяет срок действия сертификата
- Если до истечения менее 30 дней - запускается обновление

### 2. Обновление сертификата
- Останавливается nginx контейнер
- Создается резервная копия текущих сертификатов
- Запускается certbot в Docker контейнере
- Новые сертификаты копируются в nginx/ssl
- Перезапускается nginx контейнер

### 3. Проверка результата
- Проверяется статус nginx
- Тестируется SSL соединение
- Логируется результат операции

## Мониторинг

### Проверка статуса
```bash
# Полная проверка системы
./ssl_check.sh

# Проверка логов
tail -f logs/ssl_auto_renew.log
tail -f logs/ssl_check.log

# Проверка cron задач
crontab -l
```

### Индикаторы состояния
- ✅ **Зеленый** - все работает нормально
- ⚠️ **Желтый** - предупреждение (сертификат истекает через 7-30 дней)
- ❌ **Красный** - критическая ошибка (сертификат истек или nginx не работает)

## Устранение неполадок

### Проблема: Сертификат не обновляется
```bash
# Проверьте логи
tail -f logs/ssl_auto_renew.log

# Запустите принудительное обновление
./ssl_renew_simple.sh force

# Проверьте статус nginx
docker compose ps nginx
```

### Проблема: Nginx не запускается
```bash
# Проверьте конфигурацию nginx
docker compose logs nginx

# Перезапустите nginx
docker compose restart nginx
```

### Проблема: Права доступа к сертификатам
```bash
# Проверьте права доступа
ls -la nginx/ssl/

# Исправьте права доступа
chmod 644 nginx/ssl/fullchain.pem
chmod 600 nginx/ssl/privkey.pem
```

## Безопасность

### Резервное копирование
- Автоматическое создание резервных копий перед обновлением
- Резервные копии сохраняются в `nginx/ssl/backup_YYYYMMDD_HHMMSS/`

### Валидация сертификатов
- Проверка цепочки сертификатов
- Тестирование SSL соединения
- Валидация срока действия

## Уведомления

### Telegram уведомления (опционально)
Для настройки уведомлений в Telegram:
```bash
./setup_ssl_notifications.sh
```

## Статус системы

### Текущий статус
- ✅ SSL сертификат действителен до: 16 декабря 2025
- ✅ Nginx работает нормально
- ✅ SSL соединение работает
- ✅ Автоматическое обновление настроено
- ✅ Cron задачи активны

### Следующая проверка
- Автоматическая проверка: каждый день в 2:00 утра
- Следующее обновление: примерно 16 ноября 2025 (за 30 дней до истечения)

## Поддержка

При возникновении проблем:
1. Проверьте логи в `logs/`
2. Запустите `./ssl_check.sh` для диагностики
3. При необходимости запустите `./ssl_renew_simple.sh force`

## История изменений

- **2025-09-17** - Настроена система автообновления SSL
- **2025-09-17** - Обновлен сертификат (истекал 12 сентября)
- **2025-09-17** - Настроены cron задачи
- **2025-09-17** - Создана документация
