# Настройка возврата в Telegram Mini App после оплаты

## Обзор

После оплаты через Tinkoff пользователь автоматически возвращается в Telegram Mini App через специальные URL.

## Настройка переменных окружения

Добавьте следующие переменные в ваш `.env` файл:

```env
# Telegram Bot настройки
TELEGRAM_BOT_USERNAME=your_bot_username
TELEGRAM_RETURN_SUCCESS=https://t.me/your_bot_username?startapp=payment_success
TELEGRAM_RETURN_FAIL=https://t.me/your_bot_username?startapp=payment_fail
```

## Как это работает

### 1. Создание платежа
- При создании платежа в Tinkoff передаются URL возврата
- `SuccessURL` = `https://t.me/your_bot_username?startapp=payment_success`
- `FailURL` = `https://t.me/your_bot_username?startapp=payment_fail`

### 2. После оплаты
- Tinkoff перенаправляет пользователя на соответствующий URL
- Telegram **сразу открывает Mini App** с параметром `startapp`
- Mini App автоматически обрабатывает параметр

### 3. Обработка в Mini App
- Mini App проверяет параметр `startapp` в URL
- Показывает соответствующее сообщение пользователю
- Обновляет статус в приложении

## Настройка бота

## Преимущества использования startapp

Использование `startapp` параметра дает следующие преимущества:

1. **Мгновенное открытие Mini App** - пользователь сразу попадает в приложение
2. **Лучший UX** - нет промежуточных шагов через бота
3. **Автоматическая обработка** - параметры передаются прямо в Mini App
4. **Fallback поддержка** - если `startapp` не работает, бот покажет сообщение с кнопкой

### Обработка параметров

Mini App автоматически обрабатывает:
- `startapp=payment_success` - успешный платеж
- `startapp=payment_fail` - неудачный платеж

### Fallback механизм

Если по какой-то причине `startapp` не работает, система автоматически:
1. Telegram откроет бота с параметром `start`
2. Бот покажет соответствующее сообщение о статусе платежа
3. Предоставит кнопку для открытия Mini App

### Логирование

В логах Mini App вы увидите:
```
Обработка возврата из платежа: payment_success
```

## Тестирование

1. Создайте платеж в Mini App
2. Перейдите по ссылке Tinkoff
3. Завершите или отмените оплату
4. Проверьте, что вы возвращаетесь в Mini App с правильным сообщением

## Troubleshooting

### Проблема: Пользователь не возвращается в Mini App
- Проверьте правильность `TELEGRAM_BOT_USERNAME`
- Убедитесь, что бот обрабатывает команду `/start` с параметрами
- Проверьте, что URL в конфигурации корректные

### Проблема: Mini App не обрабатывает параметры
- Проверьте функцию `handlePaymentReturn()` в `TelegramApp.js`
- Убедитесь, что параметры передаются в URL
- Проверьте консоль на ошибки

### Проблема: Tinkoff не перенаправляет
- Проверьте настройки в Tinkoff Kassa
- Убедитесь, что URL возврата корректные
- Проверьте логи Tinkoff на ошибки 